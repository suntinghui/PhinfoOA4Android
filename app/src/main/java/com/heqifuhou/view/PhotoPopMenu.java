package com.heqifuhou.view;import java.io.File;import java.util.List;import cn.com.phinfo.protocol.FileSearchRun.UFileItem;import com.album.PickOrTakeImageAct;import com.alibaba.fastjson.JSON;import com.heqifuhou.actbase.IBroadcastAction;import com.heqifuhou.imgutils.BitmapDataListInstanceUtils;import com.heqifuhou.imgutils.FileItem;import com.heqifuhou.view.PopupWindows.OnPopupWindowsItemListener;import android.app.Activity;import android.content.BroadcastReceiver;import android.content.Context;import android.content.Intent;import android.content.IntentFilter;import android.graphics.Bitmap;import android.net.Uri;import android.os.Bundle;import android.os.Environment;import android.provider.MediaStore;import android.view.View;import android.widget.Toast;public class PhotoPopMenu {	/* 头像名称 */	private static final String PHOTO_FILE_NAME = "temp_photo.jpg";	private File tempFile;	private static final int PHOTO_REQUEST_CAMERA = 1;// 拍照	private static final int PHOTO_REQUEST_GALLERY = 2;// 从相册中选择	private static final int PHOTO_REQUEST_CUT = 3;// 结果	private Activity act;	private View parent;	private OnPhotoDialogListener listener;	public PhotoPopMenu(Activity act, View parent,			OnPhotoDialogListener listener) {		this.act = act;		this.listener = listener;		this.parent = parent;		IntentFilter intentFilter = new IntentFilter();		intentFilter.addAction(IBroadcastAction.ACTION_SEL_PHOTOS);		act.registerReceiver(selPicBroadCastRev, intentFilter);	}	public void destory(){		act.unregisterReceiver(selPicBroadCastRev);		BitmapDataListInstanceUtils.getRefInstance().clear();	}	// 上传头像	public void showSelectDialog() {		BitmapDataListInstanceUtils.getRefInstance().clear();		showDialog();	}	private PopupWindows pop = null;	private void showDialog() {		if (pop != null && pop.isShowing()) {			return;		}		pop = new PopupWindows(act, parent, new String[] { "选择本地图片", "拍照" });		pop.show();		pop.setOnPopupWindowsItemListener(new OnPopupWindowsItemListener() {			@Override			public void onPopupWindowsItem(int pos) {				if (pos == 1) {					startPhoto();				}				if (pos == 0) {					startPhotoGallery();				}			}		});	}	// 从图库获取	private void startPhotoGallery() {		Intent intent = new Intent(act, PickOrTakeImageAct.class);		intent.putExtra(PickOrTakeImageAct.EXTRA_NUMS, 1);		act.startActivity(intent);		// Intent intent = new Intent(Intent.ACTION_PICK);		// intent.setType("image/*");		// act.startActivityForResult(intent, PHOTO_REQUEST_GALLERY);	}	private final BroadcastReceiver selPicBroadCastRev = new BroadcastReceiver() {		public void onReceive(Context context, Intent intent) {			if (IBroadcastAction.ACTION_SEL_PHOTOS.equals(intent.getAction())) {				List<FileItem> ls = BitmapDataListInstanceUtils						.getRefInstance().getListRef();				for (FileItem fit : ls) {					Uri uri = Uri.fromFile(new File(fit.getFileLocalPath()));					startPhotoZoom(uri);					break;				}				BitmapDataListInstanceUtils.getRefInstance().clear();			}		}	};	// 照象	private void startPhoto() {		Intent intent = new Intent("android.media.action.IMAGE_CAPTURE");		// 判断存储卡是否可以用，可用进行存储		if (hasSdcard()) {			intent.putExtra(MediaStore.EXTRA_OUTPUT,					Uri.fromFile(new File(Environment							.getExternalStorageDirectory(), PHOTO_FILE_NAME)));		}		act.startActivityForResult(intent, PHOTO_REQUEST_CAMERA);	}	public boolean onActivityResult(int requestCode, int resultCode, Intent data) {		if (requestCode == PHOTO_REQUEST_GALLERY) {			if (data != null) {				// 得到图片的全路径				Uri uri = data.getData();				startPhotoZoom(uri);			}			return true;		} else if (requestCode == PHOTO_REQUEST_CAMERA) {			if (hasSdcard()) {				tempFile = new File(Environment.getExternalStorageDirectory(),						PHOTO_FILE_NAME);				startPhotoZoom(Uri.fromFile(tempFile));			} else {				Toast.makeText(act, "未找到存储卡，无法存储照片！", Toast.LENGTH_LONG).show();			}			return true;		} else if (requestCode == PHOTO_REQUEST_CUT) {			if (data == null) {				return false;			}			Bundle extras = data.getExtras();			if (extras != null) {				Bitmap photo = extras.getParcelable("data");				if (listener != null) {					listener.onPhotoDialog2Bitmap(photo);				}				// this.quickHttpRequest(0x20, new ModifyAvatarRun(				// BitmapToBaseUtils.bitmapToBase64(photo)));			}			return true;		}		return false;	}	// 剪切图片	private void startPhotoZoom(Uri uri) {		// 裁剪图片意图		Intent intent = new Intent("com.android.camera.action.CROP");		intent.setDataAndType(uri, "image/*");		intent.putExtra("crop", "true");		// 裁剪框的比例，1：1		intent.putExtra("aspectX", 1);		intent.putExtra("aspectY", 1);		// 裁剪后输出图片的尺寸大小		intent.putExtra("outputX", 250);		intent.putExtra("outputY", 250);		// 图片格式		intent.putExtra("outputFormat", "JPEG");		intent.putExtra("noFaceDetection", true);// 取消人脸识别		intent.putExtra("return-data", true);// true:不返回uri，false：返回uri		act.startActivityForResult(intent, PHOTO_REQUEST_CUT);	}	private boolean hasSdcard() {		if (Environment.getExternalStorageState().equals(				Environment.MEDIA_MOUNTED)) {			return true;		} else {			return false;		}	}	public interface OnPhotoDialogListener {		void onPhotoDialog2Bitmap(Bitmap bit);	}}