package com.heqifuhou.view;import java.io.File;import android.content.Intent;import android.graphics.Bitmap;import android.net.Uri;import android.os.Bundle;import android.os.Environment;import android.provider.MediaStore;import com.heqifuhou.actbase.MyActBase;import com.heqifuhou.view.PopupDialog.OnDialogItemListener;public class PhotoDialog {	/* 头像名称 */	private static final String PHOTO_FILE_NAME = "temp_photo.jpg";	private File tempFile;	private static final int PHOTO_REQUEST_CAMERA = 1;// 拍照	private static final int PHOTO_REQUEST_GALLERY = 2;// 从相册中选择	private static final int PHOTO_REQUEST_CUT = 3;// 结果	private MyActBase act;	private OnPhotoDialogListener listener;	public PhotoDialog(MyActBase act,OnPhotoDialogListener listener){		this.act = act;		this.listener = listener;	}	// 上传头像	public void showSelectDialog() {		showDialog();	}	private void showDialog() {		PopupDialog pop = new PopupDialog(act,null,new String[] { "选择本地图片",				"拍照" });		pop.show();		pop.setOnDialogItemListener(new OnDialogItemListener() {						@Override			public void onDialogItem(int pos, Object obj) {				if(pos == 1){					startPhoto();				}				if(pos == 0){					startPhotoGallery();				}			}		});	}	//从图库获取	private void startPhotoGallery(){		Intent intent = new Intent(Intent.ACTION_PICK);		intent.setType("image/*");		act.startActivityForResult(intent, PHOTO_REQUEST_GALLERY);	}		//照象	private void startPhoto(){		Intent intent = new Intent(				"android.media.action.IMAGE_CAPTURE");		// 判断存储卡是否可以用，可用进行存储		if (hasSdcard()) {			intent.putExtra(MediaStore.EXTRA_OUTPUT, Uri					.fromFile(new File(Environment							.getExternalStorageDirectory(),							PHOTO_FILE_NAME)));		}		act.startActivityForResult(intent, PHOTO_REQUEST_CAMERA);	}	public boolean onActivityResult(int requestCode, int resultCode, Intent data) {		if (requestCode == PHOTO_REQUEST_GALLERY) {			if (data != null) {				// 得到图片的全路径				Uri uri = data.getData();				startPhotoZoom(uri);			}			return true;		} else if (requestCode == PHOTO_REQUEST_CAMERA) {			if (hasSdcard()) {				tempFile = new File(Environment.getExternalStorageDirectory(),						PHOTO_FILE_NAME);				startPhotoZoom(Uri.fromFile(tempFile));			} else {				act.showToast("未找到存储卡，无法存储照片！");			}			return true;		} else if (requestCode == PHOTO_REQUEST_CUT) {			if (data == null) {				return false;			}			Bundle extras = data.getExtras();			if (extras != null) {				Bitmap photo = extras.getParcelable("data");				if(listener!=null){					listener.onPhotoDialog2Bitmap(photo);				}				// this.quickHttpRequest(0x20, new ModifyAvatarRun(				// BitmapToBaseUtils.bitmapToBase64(photo)));			}			return true;		}		return false;	}	// 剪切图片	private void startPhotoZoom(Uri uri) {		// 裁剪图片意图		Intent intent = new Intent("com.android.camera.action.CROP");		intent.setDataAndType(uri, "image/*");		intent.putExtra("crop", "true");		// 裁剪框的比例，1：1		intent.putExtra("aspectX", 1);		intent.putExtra("aspectY", 1);		// 裁剪后输出图片的尺寸大小		intent.putExtra("outputX", 250);		intent.putExtra("outputY", 250);		// 图片格式		intent.putExtra("outputFormat", "JPEG");		intent.putExtra("noFaceDetection", true);// 取消人脸识别		intent.putExtra("return-data", true);// true:不返回uri，false：返回uri		act.startActivityForResult(intent, PHOTO_REQUEST_CUT);	}	private boolean hasSdcard() {		if (Environment.getExternalStorageState().equals(				Environment.MEDIA_MOUNTED)) {			return true;		} else {			return false;		}	}			public interface OnPhotoDialogListener{		void onPhotoDialog2Bitmap(Bitmap bit);	}}